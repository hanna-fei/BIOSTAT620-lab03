---
title: "lab 5"
author: "Hanna Fei"
format: html
editor: visual
embed-resources: true
---

## 1. Read in data

```{r}
library(tidyverse)
library(janitor)
library(lubridate)

url <- 'https://raw.githubusercontent.com/dmcable/BIOSTAT620W26/main/data/covid/population.csv'
if (!file.exists("covid_processed.csv"))
  download.file(
    url = url,
    destfile = "population.csv",
    method   = "libcurl",
    timeout  = 60
    )
population <- read.csv('population.csv')

head(population)

population <- population %>% 
  row_to_names(row_number = 1)
```

3.  Examine the `population` matrix you just created. Notice that 1) it is not tidy, 2) the column types are not what we want, 3) there is a redundant column for index, and 4) the first row is a header. Here are some recommendations for how to clean the data:

-   Convert `population` to a tidy dataset.

-   Make the first row the header

-   Remove the unnecessary index column and the state ID column

-   Change the name of the column with state names to `state_name`.

-   Add a column with state abbreviations called `state`. Make sure you assign the abbreviations for DC and PR correctly.

Hint 1: Use the **janitor** package to make the first row the header. Hint 2: Use `setNames(state.abb, state.name)` to map state names to abbreviations.

```{r}
states <- tibble(name = state.name, abbreviation = state.abb)

population <- population %>% 
  select("NAME", "POP_2020", "POP_2021") %>% 
  rename(state_name = NAME)

population$state <- state.abb[match(population$state_name, state.name)]

population$state[population$state_name == "District of Columbia"] <- "DC"
population$state[population$state_name == "Puerto Rico"] <- "PR"
```

4.  URL points to a JSON file that lists the states in the 10 Public Health Service (PHS) defined by CDC. We want to add these regions to the `population` dataset. To facilitate this create a dataframe called `regions` that has columns `state_name`, `region`, and `region_name`. For this exercise, we recommend:
    -   Split the states into separate rows. Hint: look up the `unnest` function.

    -   One of the regions has a long name. Change it to something shorter.

    -   Print the first few rows of regions.

    -   Make sure that the region is a factor.

```{r}
library(jsonlite)
url <- "https://raw.githubusercontent.com/dmcable/BIOSTAT620W26/main/data/covid/regions.json"
regions <- fromJSON(url) # use fromJSON to read as a data.frame
```

```{r}
# unnest to split states into rows
regions <- regions %>% 
  unnest(states)

# rename long region
regions$region_name[regions$region_name == "New York and New Jersey, Puerto Rico, Virgin Islands"] <- "NY & NJ, PR, VI"

head(regions)
str(regions$region)

# change region to factor
regions$region <- as.factor(unlist(regions$region))

regions<- regions %>% 
  rename(state_name = states)
```

5.  Add a region and region name columns to the `population` data frame using the merging or joining methods we have learned. Print out the first few rows. Hint: consider `left_join`.

```{r}
population <- population %>% 
  left_join(regions, by = "state_name")
```

6.  From reading <https://data.cdc.gov/> we learn the endpoint `https://data.cdc.gov/resource/pwn4-m3yp.json` provides state level data from SARS-COV2 cases. We use **httr2** tools to download this into a data frame. Question: what would happen and why if you replaced `"?$limit=10000000000"` with `""`?

    If replaced `"?$limit=10000000000"` with `""` it would limit the rows to 1000.

```{r}
library(httr2)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
request <- request(paste0(api,paste0("?$limit=10000000000")))
response <- request |> req_perform() |> resp_body_string()
cases_raw <- fromJSON(response)
head(cases_raw)
```

7.  Wrangle the `cases_raw` to produce a data frame with columns `state`, `date` (should be the end date) and `cases`. For this task:
    -   Make sure the cases are numeric and the dates are in `Date` format. Hint: check out the `lubridate` package.
    -   Print out the first several rows.

```{r}
cases_raw$date <- as.Date(cases_raw$end_date)
cases_raw <- cases_raw %>% 
  rename(cases = tot_cases) %>%
  mutate(cases = as.numeric(cases)) %>% 
  select(state, date, cases)
head(cases_raw)
```
