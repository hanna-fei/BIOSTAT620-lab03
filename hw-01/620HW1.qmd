---
title: "BIOSTAT 620 HW 1"
author: "Hanna Fei"
format: html
editor: visual
embed-resources: true
toc: true
---

## Read in data

```{r}
air_05 <- read.csv("MI_05.csv")
air_25 <- read.csv("MI_25.csv")
suppressPackageStartupMessages(library(dplyr))
```

## 1. EDA

For each of the two datasets, check the dimensions, headers, footers, variable names and variable types. Check the distribution of the key variable we are analyzing (PM2.5). Write up a summary of all of your findings.

```{r}
# check 2005
dim(air_05)
head(air_05)
tail(air_05)
str(air_05)
hist(air_05$Daily.Mean.PM2.5.Concentration)

# check 2025
dim(air_25)
head(air_25)
tail(air_25)
str(air_25)
hist(air_25$Daily.Mean.PM2.5.Concentration)
```

I noticed that data from several days are missing for some sites. The distribution of PM2.5 concentration is right skewed for both 2005 and 2025. The 2005 PM2.5 has a peak between 5-10 with a gradual tail, while the 2025 PM2.5 has a much stronger right skew with most of its PM2.5 between 0-10 and a steep drop-off, meaning it has much fewer higher PM2.5 days. From these distributions, we can see that the air quality has improved within the last 20 years.

## 2. Combine the datasets

Combine the two years of data into one data frame. Use the `Date` variable to create a new column for year, which will serve as an identifier. Change the names of the key variables so that they are easier to refer to in your code.

```{r}
# change date variables to date class
suppressPackageStartupMessages(library(lubridate))
air_05$Date <- mdy(air_05$Date)
air_25$Date <- mdy(air_25$Date)

# create year column
air_05$year <- year(air_05$Date)
air_25$year <- year(air_25$Date)

# merge data
air_merge <- rbind(air_05, air_25)

# change variable names and select variables of interest
air <- air_merge %>% 
  rename(pm_2.5 = Daily.Mean.PM2.5.Concentration,
         method_code = Method.Code,
         city = CBSA.Name,
         county = County,
         state = State,
         lat = Site.Latitude,
         lon = Site.Longitude,
         date = Date,
         site = Site.ID
         ) %>% 
  select(date, year, pm_2.5, method_code, site, city, county, state, lat, lon)
```

## 3. Create a map

Create a basic map (or maps) in either `leaflet` or `ggplot` showing the locations of the monitoring sites, using different colors for each year. Summarize the spatial distribution of the sites. Does this distribution change from 2005 to 2025?

```{r}
suppressPackageStartupMessages(library(leaflet))
# set up data: show locations of monitoring sites, diff colors by year

air_sites <- air %>% 
  select(site, year, lat, lon) %>% 
  distinct(site, year, lat, lon) %>% 
  mutate(year = as.factor(year))
  
year.pal <- colorFactor(c('red', 'blue'), domain = air_sites$year)

sites_map <- leaflet(air_sites) %>% 
  addProviderTiles('CartoDB.Positron') %>% 
  addCircles(lat = ~lat, lng = ~lon,
             label = ~paste0(year), color= ~year.pal(year),
             opacity = 0.4, fillOpacity = 0.3, radius = 500) %>% 
  addLegend('bottomleft', pal = year.pal, values = air_sites$year,
            title = 'Year', opacity = 1)

sites_map
```

Looking at the spatial distribution of the sites, it seems the 2005 sites were more spread out around the state with some clustering at Detroit. There were a few less sites in 2025, with more focus on larger metropolitan areas like in Detroit, Grand Rapids, and a handful of smaller cities.

## 4. Check data issues

Check for any data issues such as missing or implausible values of PM in the combined dataset.

```{r}
summary(air$pm_2.5)
sum(is.na(air$pm_2.5))

air %>% arrange(desc(pm_2.5)) %>% 
  head(6)
```

There are no NAs of PM, but there are high outlier values of PM (116 and 100.6) given that the distribution tapers off around 60-80. However, it does not seem impossible since there are quite a few values around 80.

Let’s look more closely at the methods used for data collection. Look at the distribution of the method code variable. Examine the two most common method codes in the [EPA PM2.5 Codetable](https://aqs.epa.gov/aqsweb/documents/codetables/methods_speciation.html), and describe your findings.

```{r}
method_dist <- table(air$method_code)
barplot(method_dist)
```

The most common method codes are 118 and 636. Through examining these two method codes in the codetable, I noticed there are different analysis, collection, and recording types for each method.

Calculate the proportion of missing values and method code for each year and report any temporal patterns you see in these observations. Why might these temporal patterns matter?

```{r}
# proportion of missing method code values for each year
sum(is.na(air$method_code))
na_05 <- sum(is.na(air$method_code[air$year == 2005]))
na_25 <- sum(is.na(air$method_code[air$year == 2025]))
all_25 <- sum(air$year == 2025)

prop_25 <- na_25 / all_25
prop_25

method_dist05 <- table(air$method_code[air$year == 2005], useNA = "ifany")
method_dist25 <- table(air$method_code[air$year == 2025], useNA = "ifany")

barplot(method_dist05)
barplot(method_dist25)
```

In 2025, there is a much larger number and proportion of NA values compared to 2005 when there are 0 NA values. Missing values in 2025 make up more than 25% of the method data, which could lead to bias from an unknown method and affect analysis results. Additionally, in 2005 the primary method was 118, while in 2025 the primary method was 636 along with a few other methods. Having different methods for each year can make it difficult to compare the measurements of pollution between years. The measures can be affected by differences in collection and analysis methods.

## 5. Explore question of interest

Explore the main question of interest at three different levels of spatial resolution. Create data visualizations (e.g. boxplots, histograms, line plots, violin plots) **and** summary statistics that best suit each level of the analysis. Be sure to write up explanations of what you observe at each level. For levels 2 and 3, include at least one spatial plot.

Primary question: whether daily concentrations of PM (particulate matter air pollution with aerodynamic diameter less than 2.5 m) decreased in Michigan over the 20 years spanning from 2005 to 2025.

### Level 1: State

The histograms from the exploratory analysis in (1.) show a decrease in PM from 2005 to 2025.

```{r}
library(ggplot2)

# boxplot
ggplot(air) +
  geom_boxplot(mapping = aes(x = factor(year), y = pm_2.5)) +
  labs(x = "Year", y = "PM", 
       title = "Particular Matter Air Pollution in 2005 vs 2025")

# summary statistics
summary(air$pm_2.5[air$year == 2005])
summary(air$pm_2.5[air$year == 2025])
```

As shown from the exploratory data analysis histograms, boxplots, and summary statistics, the average PM in 2025 has decreased since 2005 in the state of Michigan. The boxplot for 2025 shows the two high outliers and in general has a larger range of outliers than 2005.

### Level 2: County

```{r}
library(tidyr)

# assess number of counties
counties <- unique(air$county)

air_merge <- air_merge %>% 
  rename(pm_2.5 = Daily.Mean.PM2.5.Concentration,
         method_code = Method.Code,
         city = CBSA.Name,
         county = County,
         state = State,
         lat = Site.Latitude,
         lon = Site.Longitude,
         date = Date,
         site = Site.ID,
         county_id = County.FIPS.Code
         )

# grouping mean pm for each county in both years
county_pm <- air_merge %>% 
  group_by(county, year) %>% 
  summarize(mean_pm = mean(pm_2.5))

# difference in PM by county
diffs <- county_pm %>%
  pivot_wider(names_from = year, values_from = mean_pm) %>%
  mutate(diff_pm = `2025` - `2005`) %>% 
  filter(!is.na(diff_pm))

# horizontal bar chart
ggplot(diffs) +
  geom_col(mapping = aes(x = reorder(county, diff_pm), y = diff_pm, fill = diff_pm)) +
  coord_flip() +
  labs(title = "Change in PM by County (2025 - 2005)", 
       x = "County", y = "Change in PM") +
  theme_minimal() +
  scale_fill_gradient2(low = "blue2", high = "red", mid = "white", midpoint = 0,
                       name = "Change in PM (2025 - 2005)")
```

This bar chart shows the mean PM in 2005 and 2025 for each county in Michigan that was observed both years. The bar chart is ordered by increasing difference in mean PM between 2005 and 2025. We can see that for every county except for Schoolcraft, the mean PM is lower in 2025 than in 2005.

#### Chloropleth Map

```{r}
#| output: false

library(sf)
library(tigris)

mi_counties <- counties(state = "MI", cb = TRUE) %>% st_as_sf()
```

```{r}
county_diffs <- mi_counties %>% 
  left_join(diffs, by = c("NAME" = "county"))

ggplot(county_diffs) +
  geom_sf(aes(fill = diff_pm), color = "white") +
  scale_fill_gradient2(
    low = "blue3", high = "red", midpoint = 0,
    na.value = "lightgrey",
    name = "Change in PM (2025 - 2005)"
  ) +
  theme_minimal() +
  labs(title = "Change in Mean PM by County in 2025 vs. 2005")
```

```{r}
summary(diffs)

mean_change <- mean(diffs$diff_pm)

summary_counties <- diffs %>%
  summarise(
    mean_change = mean(diffs$diff_pm),
    median_change = median(diffs$diff_pm),
    min_change = min(diffs$diff_pm),
    max_change = max(diffs$diff_pm),
    n_decrease = sum(diffs$diff_pm < 0),
    n_increase = sum(diffs$diff_pm > 0)
  ) %>% 
  select(!county) %>% 
  slice(1)

summary_counties
```

The summary statistics show that the change in PM from 2005 to 2025 had a mean of -5.19 and median of -5.67, with 14 counties having a decrease in PM and one with an increase in PM of those that were measured.

We can observe from these analyses that from 2005 to 2025, the average daily concentration of PM decreased in all measured counties in Michigan except Schoolcraft.

### Level 3: Cities

```{r}
# Restrict the data to sites in Wayne county
wayne <- air_merge %>% 
  filter(county == "Wayne") %>% 
  rename(site_name = Local.Site.Name) %>% 
  group_by(site_name, year) %>% 
  summarise(mean_pm = mean(pm_2.5)) %>% 
  pivot_wider(names_from = year, values_from = mean_pm) %>% 
  filter(!is.na(`2025`) & !is.na(`2005`)) %>% 
  mutate(diff_pm = `2025` - `2005`)

# rename the sites
wayne$site_name[2] <- "Southwest Detroit"
wayne$site_name[4] <- "Dearborn"


wayne_long <- wayne %>% 
  pivot_longer(cols = c(`2005`, `2025`),
               names_to = "year", values_to = "mean_pm") %>% 
    mutate(year = factor(year, levels = c("2025", "2005")))

ggplot(wayne_long) +
  geom_col(mapping = aes(x = reorder(site_name, diff_pm), y = mean_pm, 
                         fill = year), 
           position = "dodge") +
  coord_flip() +
  labs(title = "Mean PM by Sites in Wayne County in 2005 vs. 2025", 
       x = "Site", y = "Mean PM", fill = "Year")
```

```{r}
summary(wayne)
```

There are only 4 sites in Wayne County that were used in both 2005 and 2025. The bar chart shows that all 4 sites had a lower mean PM in 2025 than in 2005. The mean difference in PM was -8.66, and the median was -8.58.

We can observe from these observations that the average daily concentration of PM decreased in Wayne County from 2005 to 2025.
